<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Booking - Prince Alex Airbnb</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; color: #333; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        .navbar { position: fixed; top: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); z-index: 1000; padding: 1rem 0; box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-logo h2 { font-family: 'Montserrat', sans-serif; color: #1a365d; font-size: 1.5rem; font-weight: 600; }
        .nav-logo span { color: #d4af37; font-size: 0.9rem; font-weight: 400; }
        .nav-menu { display: flex; align-items: center; gap: 2rem; }
        .nav-link { text-decoration: none; color: #333; font-weight: 500; transition: color 0.3s ease; position: relative; }
        .nav-link:hover, .nav-link.active { color: #d4af37; }
        .nav-link.active::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: #d4af37; }
        .login-btn { background: #d4af37; color: white !important; padding: 0.5rem 1.5rem; border-radius: 25px; transition: all 0.3s ease; }
        .login-btn:hover { background: #b8941f; transform: translateY(-2px); }
        
        .user-menu { position: relative; display: none; }
        .user-menu-btn { display: flex; align-items: center; gap: 0.5rem; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 25px; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.3s ease; font-family: 'Poppins', sans-serif; font-weight: 500; color: #333; min-height: 44px; }
        .user-menu-btn:hover { background: #e9ecef; border-color: #d4af37; transform: translateY(-2px); }
        .user-menu-btn img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .dropdown-arrow { font-size: 0.8rem; transition: transform 0.3s ease; }
        .user-menu-btn:hover .dropdown-arrow { transform: rotate(180deg); }
        .user-dropdown { position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e9ecef; border-radius: 10px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); min-width: 200px; z-index: 1000; display: none; margin-top: 0.5rem; }
        .dropdown-item { display: flex; align-items: center; gap: 0.8rem; padding: 1rem; text-decoration: none; color: #333; transition: background-color 0.3s ease; border-bottom: 1px solid #f8f9fa; min-height: 44px; }
        .dropdown-item:hover { background: #f8f9fa; color: #d4af37; }
        .dropdown-item:last-child { border-bottom: none; }
        .item-icon { font-size: 1.2rem; width: 20px; text-align: center; }
        
        .hamburger { display: none; flex-direction: column; cursor: pointer; z-index: 1001; }
        .hamburger span { width: 25px; height: 3px; background: #333; margin: 3px 0; transition: 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }
        
        .booking-section { margin-top: 100px; padding: 2rem 0; }
        .booking-header { text-align: center; margin-bottom: 3rem; }
        .booking-header h1 { font-size: 2.5rem; font-weight: 600; color: #1a365d; margin-bottom: 1rem; }
        .booking-header p { font-size: 1.1rem; color: #666; }
        
        .booking-container { display: grid; grid-template-columns: 1fr 400px; gap: 3rem; }
        .booking-form { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08); }
        .booking-summary { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08); height: fit-content; position: sticky; top: 120px; }
        
        .form-section { margin-bottom: 2rem; }
        .form-section h3 { font-size: 1.3rem; font-weight: 600; color: #1a365d; margin-bottom: 1rem; }
        .form-subtitle { color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; line-height: 1.5; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-weight: 500; color: #333; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; font-family: 'Poppins', sans-serif; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        .pre-filled { border-color: #28a745 !important; background-color: #f8fff9 !important; animation: prefillPulse 0.5s ease; }
        @keyframes prefillPulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        .summary-header { margin-bottom: 1.5rem; }
        .summary-title { font-size: 1.3rem; font-weight: 600; color: #1a365d; margin-bottom: 0.5rem; }
        .room-summary { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .room-image { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; }
        .room-info h4 { font-size: 1.1rem; font-weight: 600; color: #1a365d; margin-bottom: 0.3rem; }
        .room-info p { color: #666; font-size: 0.9rem; }
        
        .booking-details { margin-bottom: 1.5rem; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding: 0.5rem 0; }
        .detail-row:not(:last-child) { border-bottom: 1px solid #f8f9fa; }
        .detail-label { color: #666; font-size: 0.9rem; }
        .detail-value { font-weight: 600; color: #333; }
        
        .price-breakdown { background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .price-row:last-child { border-top: 1px solid #ddd; padding-top: 0.8rem; margin-top: 0.8rem; font-weight: 600; font-size: 1.1rem; }
        .price-label { color: #666; }
        .price-value { font-weight: 600; color: #333; }
        .total-price { color: #d4af37 !important; }
        
        .payment-methods { margin-bottom: 2rem; }
        .payment-method { display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 10px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease; }
        .payment-method:hover { border-color: #d4af37; }
        .payment-method.selected { border-color: #d4af37; background: #fffbf0; }
        .payment-method input[type="radio"] { display: none; }
        .payment-icon { font-size: 1.5rem; }
        .payment-info h4 { font-size: 1rem; font-weight: 600; color: #1a365d; margin-bottom: 0.2rem; }
        .payment-info p { color: #666; font-size: 0.8rem; }
        
        .booking-btn { width: 100%; background: linear-gradient(135deg, #d4af37, #b8941f); color: white; border: none; padding: 1.2rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 1rem; }
        .booking-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3); }
        .booking-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .terms-text { font-size: 0.8rem; color: #666; text-align: center; line-height: 1.5; }
        .terms-text a { color: #d4af37; text-decoration: none; }
        .terms-text a:hover { text-decoration: underline; }
        
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { position: relative; background-color: white; margin: 5% auto; padding: 2rem; width: 90%; max-width: 500px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); text-align: center; }
        .close-modal { position: absolute; top: 1rem; right: 1.5rem; font-size: 2rem; cursor: pointer; color: #666; }
        .close-modal:hover { color: #333; }
        .success-icon { font-size: 4rem; margin-bottom: 1rem; }
        .modal h2 { color: #28a745; font-size: 1.8rem; margin-bottom: 1rem; }
        .modal p { color: #666; margin-bottom: 1.5rem; line-height: 1.6; }
        .modal-actions { display: flex; gap: 1rem; justify-content: center; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: #d4af37; color: white; }
        .btn-primary:hover { background: #b8941f; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        
        .footer { background: #1a1a1a; color: white; padding: 3rem 0 1rem; margin-top: 3rem; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem; }
        .footer-section h3, .footer-section h4 { margin-bottom: 1rem; color: #d4af37; }
        .footer-section p, .footer-section li { margin-bottom: 0.5rem; opacity: 0.8; }
        .footer-section ul { list-style: none; }
        .footer-section a { color: white; text-decoration: none; opacity: 0.8; transition: opacity 0.3s ease; }
        .footer-section a:hover { opacity: 1; color: #d4af37; }
        .social-links { display: flex; gap: 1rem; margin-top: 1rem; }
        .social-links a { font-size: 1.5rem; transition: transform 0.3s ease; }
        .social-links a:hover { transform: scale(1.2); }
        .footer-bottom { text-align: center; padding-top: 2rem; border-top: 1px solid #333; opacity: 0.6; }
        .designer-credit { margin-top: 0.5rem; font-size: 0.9rem; }
        .designer-credit a { color: #d4af37; text-decoration: none; font-weight: 500; transition: all 0.3s ease; }
        .designer-credit a:hover { color: #b8941f; text-decoration: underline; }
        
        @media (max-width: 1024px) { .booking-container { grid-template-columns: 1fr; } .booking-summary { position: static; } }
        @media (max-width: 768px) { 
            .hamburger { display: flex; } 
            .nav-menu { position: fixed; left: -100%; top: 70px; flex-direction: column; background: white; width: 100%; text-align: center; transition: 0.3s; box-shadow: 0 10px 27px rgba(0, 0, 0, 0.05); padding: 2rem 0; } 
            .nav-menu.active { left: 0; } 
            .form-grid { grid-template-columns: 1fr; } 
            .booking-header h1 { font-size: 2rem; }
        }
        @media (max-width: 480px) { .container { padding: 0 15px; } .booking-form, .booking-summary { padding: 1.5rem; } }
        
        html { scroll-behavior: smooth; }
        @media (max-width: 768px) { button, .btn, .booking-btn, input[type="submit"], input[type="button"] { min-height: 44px; touch-action: manipulation; } body { font-size: 16px; -webkit-text-size-adjust: 100%; } input, select, textarea { font-size: 16px; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>Prince Alex Airbnb</h2>
                <span>Uthiru, Nairobi</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="listings.html" class="nav-link">Rooms</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="login.html" class="nav-link login-btn" id="login-nav-btn">Login</a>
                <div class="user-menu" id="user-menu" style="display: none;">
                    <button class="user-menu-btn" onclick="toggleUserMenu()">
                        <img id="user-avatar" src="images/prince-alex.png" alt="User Avatar">
                        <span id="user-name">Guest</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href="profile.html" class="dropdown-item">
                            <span class="item-icon">👤</span>
                            <span>My Profile</span>
                        </a>
                        <a href="listings.html" class="dropdown-item">
                            <span class="item-icon">🏠</span>
                            <span>Browse Rooms</span>
                        </a>
                        <button onclick="logout()" class="dropdown-item" style="background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                            <span class="item-icon">🚪</span>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="hamburger"><span></span><span></span><span></span></div>
        </div>
    </nav>

    <section class="booking-section">
        <div class="container">
            <div class="booking-header">
                <h1>Complete Your Booking</h1>
                <p>You're just a few steps away from your perfect stay</p>
            </div>
            
            <div class="booking-container">
                <div class="booking-form">
                    <div class="form-section">
                        <h3>Guest Information</h3>
                        <p class="form-subtitle">Please provide your details for the booking</p>
                        <form id="booking-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="firstName">First Name *</label>
                                    <input type="text" id="firstName" name="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name *</label>
                                    <input type="text" id="lastName" name="lastName" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email Address *</label>
                                    <input type="email" id="email" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number *</label>
                                    <input type="tel" id="phone" name="phone" required>
                                </div>
                                <div class="form-group full-width">
                                    <label for="specialRequests">Special Requests</label>
                                    <textarea id="specialRequests" name="specialRequests" placeholder="Any special requests or preferences..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-section">
                        <h3>Payment Method</h3>
                        <div class="payment-methods">
                            <label class="payment-method selected" onclick="selectPaymentMethod('mpesa')">
                                <input type="radio" name="paymentMethod" value="mpesa" checked>
                                <div class="payment-icon">📱</div>
                                <div class="payment-info">
                                    <h4>M-Pesa</h4>
                                    <p>Pay securely with M-Pesa mobile money</p>
                                </div>
                            </label>
                            <label class="payment-method" onclick="selectPaymentMethod('card')">
                                <input type="radio" name="paymentMethod" value="card">
                                <div class="payment-icon">💳</div>
                                <div class="payment-info">
                                    <h4>Credit/Debit Card</h4>
                                    <p>Visa, Mastercard accepted</p>
                                </div>
                            </label>
                            <label class="payment-method" onclick="selectPaymentMethod('bank')">
                                <input type="radio" name="paymentMethod" value="bank">
                                <div class="payment-icon">🏦</div>
                                <div class="payment-info">
                                    <h4>Bank Transfer</h4>
                                    <p>Direct bank transfer</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="booking-summary">
                    <div class="summary-header">
                        <h3 class="summary-title">Booking Summary</h3>
                    </div>
                    
                    <div class="room-summary" id="room-summary">
                        <!-- Room details will be loaded here -->
                    </div>
                    
                    <div class="booking-details" id="booking-details">
                        <!-- Booking details will be loaded here -->
                    </div>
                    
                    <div class="price-breakdown" id="price-breakdown">
                        <!-- Price breakdown will be loaded here -->
                    </div>
                    
                    <button class="booking-btn" onclick="completeBooking()">
                        <span id="booking-btn-text">Complete Booking</span>
                    </button>
                    
                    <div class="terms-text">
                        By completing this booking, you agree to our 
                        <a href="#" onclick="showTerms()">Terms of Service</a> and 
                        <a href="#" onclick="showPrivacy()">Privacy Policy</a>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="testBookingSave()" style="width: 100%; margin-top: 1rem;">Test Database Connection</button>
                </div>
            </div>
        </div>
    </section>

    <div id="booking-success-modal" class="modal">
        <div class="modal-content">
            <div class="success-icon">📋</div>
            <h2>Booking Submitted Successfully!</h2>
            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 10px; margin: 1rem 0; border-left: 4px solid #d4af37;">
                <h4 style="color: #1a365d; margin-bottom: 1rem;">📌 What Happens Next?</h4>
                <div style="text-align: left; color: #666; line-height: 1.6;">
                    <p style="margin-bottom: 0.8rem;">✅ <strong>Booking Received:</strong> Your reservation request has been submitted successfully</p>
                    <p style="margin-bottom: 0.8rem;">⏳ <strong>Pending Approval:</strong> Prince Alex will review and approve your booking within 24 hours</p>
                    <p style="margin-bottom: 0.8rem;">📧 <strong>Confirmation Email:</strong> You'll receive confirmation once approved</p>
                    <p style="margin-bottom: 0;">📞 <strong>Questions?</strong> Call us anytime at +254 717 384 875</p>
                </div>
            </div>
            <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center;">
                <p style="margin: 0; color: #666; font-size: 0.9rem;">
                    <strong>Booking Status:</strong> <span style="color: #856404; font-weight: 600;">PENDING APPROVAL</span><br>
                    <small>You can check your booking status in "My Profile" → "My Bookings"</small>
                </p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="goToProfile()">View My Bookings</button>
                <button class="btn btn-secondary" onclick="goToHome()">Back to Home</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Prince Alex Airbnb</h3>
                    <p>Your home away from home in Uthiru, Nairobi</p>
                    <div class="social-links">
                        <a href="#" aria-label="Facebook">📘</a>
                        <a href="#" aria-label="Instagram">📷</a>
                        <a href="#" aria-label="WhatsApp">📱</a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="listings.html">Rooms</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact Info</h4>
                    <p>📍 Uthiru, Nairobi, Kenya</p>
                    <p>📞 +254 717 384 875</p>
                    <p>✉️ princealexdigital@gmail.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Prince Alex Airbnb. All rights reserved.</p>
                <p class="designer-credit">Designed by <a href="https://www.princealex.pro" target="_blank" rel="noopener">Prince Alex Digital</a></p>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAUNs3WYS2mkvPvzRDfhyZFUbP2XpZjDQg", authDomain: "retailflow-pos-11726.firebaseapp.com", projectId: "retailflow-pos-11726", storageBucket: "retailflow-pos-11726.firebasestorage.app", messagingSenderId: "309314798354", appId: "1:309314798354:web:30784c2b2e7e42168629cb" };
        let firebaseApp, auth, db, storage, currentUser;
        let bookingData = {};

        const roomsData = {
            1: { id: 1, name: 'Deluxe Suite', price: 4500, type: 'suite', maxGuests: 2, image: 'https://images.unsplash.com/photo-1631049307264-da0ec9d70304?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ King Bed', '❄️ AC', '📶 WiFi', '🛁 Private Bath'] },
            2: { id: 2, name: 'Executive Room', price: 3800, type: 'double', maxGuests: 2, image: 'https://images.unsplash.com/photo-1618773928121-c32242e63f39?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ Queen Bed', '❄️ AC', '📶 WiFi', '💼 Work Desk'] },
            3: { id: 3, name: 'Standard Room', price: 3200, type: 'single', maxGuests: 2, image: 'https://images.unsplash.com/photo-1566665797739-1674de7a421a?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ Double Bed', '❄️ AC', '📶 WiFi'] },
            4: { id: 4, name: 'Family Room', price: 5200, type: 'family', maxGuests: 4, image: 'https://images.unsplash.com/photo-1595576508898-0ad5c879a061?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ 2 Beds', '❄️ AC', '📶 WiFi', '🛁 2 Baths'] },
            5: { id: 5, name: 'Premium Suite', price: 5800, type: 'suite', maxGuests: 2, image: 'https://images.unsplash.com/photo-1522771739844-6a9f6d5f14af?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ King Bed', '❄️ AC', '📶 WiFi', '🛁 Jacuzzi'] },
            6: { id: 6, name: 'Budget Room', price: 2800, type: 'budget', maxGuests: 1, image: 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ Single Bed', '📶 WiFi'] },
            7: { id: 7, name: 'Garden View Room', price: 4200, type: 'double', maxGuests: 2, image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ Queen Bed', '❄️ AC', '📶 WiFi', '🌿 Garden View'] },
            8: { id: 8, name: 'Business Suite', price: 4800, type: 'suite', maxGuests: 2, image: 'https://images.unsplash.com/photo-1631049035182-249067d7618e?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80', features: ['🛏️ King Bed', '❄️ AC', '📶 WiFi', '💼 Office Space'] }
        };

        function initializeFirebase() {
            if (typeof firebase !== 'undefined') {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    updateNavigationForAuthState(user);
                    if (user) {
                        loadUserDataFromFirebase();
                    }
                });
                return true;
            }
            return false;
        }

        function updateNavigationForAuthState(user) {
            const loginBtn = document.getElementById('login-nav-btn');
            const userMenu = document.getElementById('user-menu');
            
            if (user) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (userMenu) {
                    userMenu.style.display = 'block';
                    const userName = document.getElementById('user-name');
                    const userAvatar = document.getElementById('user-avatar');
                    if (userName) {
                        const displayName = user.displayName || 'User';
                        userName.textContent = displayName.split(' ')[0];
                    }
                    if (userAvatar && user.photoURL) {
                        userAvatar.src = user.photoURL;
                    }
                }
            } else {
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (userMenu) userMenu.style.display = 'none';
            }
        }
        
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        async function logout() {
            try {
                await auth.signOut();
                showNotification('👋 Successfully logged out', 'success');
                setTimeout(() => window.location.href = 'index.html', 1000);
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error logging out. Please try again.', 'error');
            }
        }

        async function loadUserDataFromFirebase() {
            if (!currentUser) return;
            try {
                const userDoc = await db.collection('customers').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    let fieldsPreFilled = 0;
                    
                    if (userData.firstName) {
                        const field = document.getElementById('firstName');
                        field.value = userData.firstName;
                        field.classList.add('pre-filled');
                        fieldsPreFilled++;
                    }
                    if (userData.lastName) {
                        const field = document.getElementById('lastName');
                        field.value = userData.lastName;
                        field.classList.add('pre-filled');
                        fieldsPreFilled++;
                    }
                    if (userData.email) {
                        const field = document.getElementById('email');
                        field.value = userData.email;
                        field.classList.add('pre-filled');
                        fieldsPreFilled++;
                    }
                    if (userData.phone) {
                        const field = document.getElementById('phone');
                        field.value = userData.phone;
                        field.classList.add('pre-filled');
                        fieldsPreFilled++;
                    }
                    
                    const formSubtitle = document.querySelector('.form-subtitle');
                    if (formSubtitle && fieldsPreFilled > 0) {
                        formSubtitle.innerHTML = `Welcome back, ${userData.firstName || 'User'}! Your information has been pre-filled from your profile. <br><small style="color: #666;">✏️ You can modify any details if needed before booking.</small>`;
                        formSubtitle.style.color = '#28a745';
                        formSubtitle.style.fontWeight = '500';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function initializeMobileNavigation() {
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');
            const body = document.body;
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', function(e) {
                    e.stopPropagation();
                    navMenu.classList.toggle('active');
                    hamburger.classList.toggle('active');
                    body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : 'auto';
                });
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                        body.style.overflow = 'auto';
                    });
                });
            }
        }

        function loadBookingData() {
            const roomId = localStorage.getItem('selectedRoomId');
            const searchCriteria = JSON.parse(localStorage.getItem('searchCriteria') || '{}');
            
            if (!roomId || !roomsData[roomId]) {
                showNotification('Room not found. Redirecting to rooms page...', 'error');
                setTimeout(() => window.location.href = 'listings.html', 2000);
                return;
            }
            
            const room = roomsData[roomId];
            const checkin = searchCriteria.checkin || getTodayDate();
            const checkout = searchCriteria.checkout || getTomorrowDate();
            const guests = parseInt(searchCriteria.guests) || 1;
            const nights = calculateNights(checkin, checkout);
            
            bookingData = {
                roomId: room.id,
                roomName: room.name,
                roomPrice: room.price,
                roomImage: room.image,
                checkin,
                checkout,
                nights,
                guests,
                subtotal: room.price * nights,
                cleaningFee: 500,
                serviceFee: Math.round((room.price * nights) * 0.08),
                taxes: Math.round((room.price * nights) * 0.05)
            };
            
            bookingData.finalTotal = bookingData.subtotal + bookingData.cleaningFee + bookingData.serviceFee + bookingData.taxes;
            
            updateBookingSummary();
            updatePriceBreakdown();
        }

        function updateBookingSummary() {
            if (!bookingData) return;
            
            const roomSummary = document.getElementById('room-summary');
            roomSummary.innerHTML = `
                <img src="${bookingData.roomImage}" alt="${bookingData.roomName}" class="room-image">
                <div class="room-info">
                    <h4>${bookingData.roomName}</h4>
                    <p>KES ${bookingData.roomPrice.toLocaleString()} per night</p>
                </div>
            `;
            
            const bookingDetails = document.getElementById('booking-details');
            bookingDetails.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Check-in</span>
                    <span class="detail-value">${formatDate(bookingData.checkin)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Check-out</span>
                    <span class="detail-value">${formatDate(bookingData.checkout)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Nights</span>
                    <span class="detail-value">${bookingData.nights}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Guests</span>
                    <span class="detail-value">${bookingData.guests}</span>
                </div>
            `;
        }

        function updatePriceBreakdown() {
            if (!bookingData) return;
            
            const roomPricePerNight = bookingData.roomPrice || 0;
            const nights = bookingData.nights || 1;
            const calculatedSubtotal = roomPricePerNight * nights;
            const cleaningFee = bookingData.cleaningFee || 500;
            const serviceFee = bookingData.serviceFee || Math.round(calculatedSubtotal * 0.08);
            const taxAmount = Math.round(calculatedSubtotal * 0.05);
            const finalTotal = calculatedSubtotal + cleaningFee + serviceFee + taxAmount;
            
            bookingData.subtotal = calculatedSubtotal;
            bookingData.cleaningFee = cleaningFee;
            bookingData.serviceFee = serviceFee;
            bookingData.taxes = taxAmount;
            bookingData.finalTotal = finalTotal;
            
            const priceBreakdown = document.getElementById('price-breakdown');
            priceBreakdown.innerHTML = `
                <div class="price-row">
                    <span class="price-label">KES ${roomPricePerNight.toLocaleString()} × ${nights} night${nights > 1 ? 's' : ''}</span>
                    <span class="price-value">KES ${calculatedSubtotal.toLocaleString()}</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Cleaning fee</span>
                    <span class="price-value">KES ${cleaningFee.toLocaleString()}</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Service fee</span>
                    <span class="price-value">KES ${serviceFee.toLocaleString()}</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Taxes</span>
                    <span class="price-value">KES ${taxAmount.toLocaleString()}</span>
                </div>
                <div class="price-row">
                    <span class="price-label total-price">Total</span>
                    <span class="price-value total-price">KES ${finalTotal.toLocaleString()}</span>
                </div>
            `;
        }

        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.querySelector(`input[value="${method}"]`).checked = true;
        }

        async function completeBooking() {
            const form = document.getElementById('booking-form');
            const formData = new FormData(form);
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const bookingBtn = document.querySelector('.booking-btn');
            const btnText = document.getElementById('booking-btn-text');
            bookingBtn.disabled = true;
            btnText.textContent = 'Processing...';
            
            try {
                console.log('🔄 Starting booking process...');
                console.log('📊 Booking data:', bookingData);
                console.log('👤 Current user:', currentUser?.uid);
                
                const firebaseBookingData = {
                    userId: currentUser?.uid || 'anonymous',
                    roomId: bookingData.roomId || 1,
                    roomName: bookingData.roomName || 'Unknown Room',
                    roomPrice: bookingData.roomPrice || 0,
                    checkin: bookingData.checkin || new Date().toISOString().split('T')[0],
                    checkout: bookingData.checkout || new Date(Date.now() + 86400000).toISOString().split('T')[0],
                    nights: bookingData.nights || 1,
                    guests: bookingData.guests || 1,
                    subtotal: bookingData.subtotal || 0,
                    cleaningFee: bookingData.cleaningFee || 500,
                    serviceFee: bookingData.serviceFee || 0,
                    taxes: bookingData.taxes || 0,
                    finalTotal: bookingData.finalTotal || 0,
                    guestName: `${formData.get('firstName')} ${formData.get('lastName')}`,
                    guestEmail: formData.get('email'),
                    guestPhone: formData.get('phone'),
                    specialRequests: formData.get('specialRequests'),
                    paymentMethod: paymentMethod,
                    status: 'pending',
                    paymentStatus: 'pending',
                    adminApproved: false,
                    requiresApproval: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const cleanBookingData = {};
                Object.keys(firebaseBookingData).forEach(key => {
                    if (firebaseBookingData[key] !== undefined && firebaseBookingData[key] !== null) {
                        cleanBookingData[key] = firebaseBookingData[key];
                    }
                });
                
                const booking = {
                    ...cleanBookingData,
                    total: cleanBookingData.finalTotal || 0,
                    roomType: bookingData.roomType || 'standard',
                    bookingReference: `PA${Date.now()}`,
                    confirmationSent: false
                };
                
                const validationResult = validateBookingDataForFirestore(booking);
                if (!validationResult.isValid) {
                    throw new Error(`Invalid booking data: ${validationResult.errors.join(', ')}`);
                }
                
                console.log('✅ Booking data validated, saving to Firestore...');
                const bookingRef = await db.collection('bookings').add(booking);
                console.log('🎉 Booking saved successfully with ID:', bookingRef.id);
                
                if (currentUser) {
                    await updateUserBookingStats(booking);
                }
                
                showSuccessModal();
                localStorage.removeItem('selectedRoomId');
                localStorage.removeItem('searchCriteria');
                
            } catch (error) {
                console.error('❌ Booking error:', error);
                showNotification(`Booking failed: ${error.message}`, 'error');
            }
            
            bookingBtn.disabled = false;
            btnText.textContent = 'Complete Booking';
        }

        function validateBookingDataForFirestore(data) {
            const errors = [];
            const requiredFields = ['userId', 'roomId', 'roomName', 'checkin', 'checkout', 'nights', 'guests', 'finalTotal'];
            
            requiredFields.forEach(field => {
                if (data[field] === undefined || data[field] === null || data[field] === '') {
                    errors.push(`${field} is required`);
                }
            });
            
            if (typeof data.nights !== 'number' || data.nights <= 0) {
                errors.push('nights must be a positive number');
            }
            
            if (typeof data.guests !== 'number' || data.guests <= 0) {
                errors.push('guests must be a positive number');
            }
            
            if (typeof data.finalTotal !== 'number' || data.finalTotal <= 0) {
                errors.push('finalTotal must be a positive number');
            }
            
            return { isValid: errors.length === 0, errors };
        }

        async function updateUserBookingStats(booking) {
            if (!currentUser) return;
            try {
                const userRef = db.collection('customers').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const currentStats = userData.stats || {};
                    const currentFavoriteRooms = currentStats.favoriteRooms || [];
                    
                    if (!currentFavoriteRooms.includes(booking.roomId)) {
                        currentFavoriteRooms.push(booking.roomId);
                    }
                    
                    await userRef.update({
                        'stats.totalBookings': (currentStats.totalBookings || 0) + 1,
                        'stats.totalSpent': (currentStats.totalSpent || 0) + booking.finalTotal,
                        'stats.lastBookingDate': firebase.firestore.FieldValue.serverTimestamp(),
                        'stats.favoriteRooms': currentFavoriteRooms
                    });
                    
                    console.log('✅ User booking stats updated successfully');
                } else {
                    console.log('⚠️ User document not found, skipping stats update');
                }
            } catch (error) {
                console.error('❌ Error updating user booking stats:', error);
            }
        }

        async function testBookingSave() {
            console.log('🧪 Testing Firebase connection...');
            try {
                if (!db) {
                    throw new Error('Firestore not initialized');
                }
                
                const testDoc = await db.collection('test').add({
                    message: 'Test connection',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ Test document created:', testDoc.id);
                await db.collection('test').doc(testDoc.id).delete();
                console.log('🗑️ Test document cleaned up');
                
                showNotification('✅ Database connection working!', 'success');
            } catch (error) {
                console.error('❌ Database test failed:', error);
                showNotification(`Database test failed: ${error.message}`, 'error');
            }
        }

        async function checkFirebaseStatus() {
            console.log('🔍 Firebase Status Check:');
            console.log('- Firebase App:', firebaseApp ? '✅ Initialized' : '❌ Not initialized');
            console.log('- Auth:', auth ? '✅ Available' : '❌ Not available');
            console.log('- Firestore:', db ? '✅ Available' : '❌ Not available');
            console.log('- Current User:', currentUser ? `✅ ${currentUser.email}` : '❌ Not logged in');
            console.log('- Booking Data:', bookingData ? '✅ Loaded' : '❌ Not loaded');
        }

        function showSuccessModal() {
            document.getElementById('booking-success-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function goToProfile() {
            document.getElementById('booking-success-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            window.location.href = 'profile.html';
        }

        function goToHome() {
            document.getElementById('booking-success-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            window.location.href = 'index.html';
        }

        function showTerms() {
            showNotification('Terms of Service - Please contact us for details', 'info');
        }

        function showPrivacy() {
            showNotification('Privacy Policy - Please contact us for details', 'info');
        }

        function calculateNights(checkin, checkout) {
            const checkinDate = new Date(checkin);
            const checkoutDate = new Date(checkout);
            const timeDiff = checkoutDate.getTime() - checkinDate.getTime();
            return Math.max(1, Math.ceil(timeDiff / (1000 * 3600 * 24)));
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function getTomorrowDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `<div class="notification-content"><span class="notification-icon">${getNotificationIcon(type)}</span><span class="notification-message">${message}</span><button class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button></div>`;
            notification.style.cssText = `position: fixed; top: 100px; right: 20px; background: ${getNotificationColor(type)}; color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 10000; min-width: 300px; max-width: 400px; animation: slideInRight 0.3s ease;`;
            const content = notification.querySelector('.notification-content');
            content.style.cssText = `display: flex; align-items: center; gap: 10px;`;
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.style.cssText = `background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: auto; padding: 0 5px;`;
            document.body.appendChild(notification);
            setTimeout(() => { if (notification.parentElement) { notification.style.animation = 'slideOutRight 0.3s ease'; setTimeout(() => notification.remove(), 300); } }, 5000);
        }

        function getNotificationIcon(type) { switch(type) { case 'success': return '✓'; case 'error': return '✗'; case 'warning': return '⚠'; default: return 'ℹ'; } }
        function getNotificationColor(type) { switch(type) { case 'success': return '#28a745'; case 'error': return '#dc3545'; case 'warning': return '#ffc107'; default: return '#007bff'; } }

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof firebase !== 'undefined') { initializeFirebase(); } else { setTimeout(() => initializeFirebase(), 1000); }
            initializeMobileNavigation();
            loadBookingData();
            checkFirebaseStatus();
        });

        const style = document.createElement('style');
        style.textContent = `@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
